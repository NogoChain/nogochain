# NogoChain 架构文档

## 1. 系统架构概述

NogoChain 是一个基于 EVM 兼容的区块链系统，采用自研的 NogoPow 共识机制。系统由以下核心模块组成：

### 1.1 核心模块

| 模块 | 职责 | 路径 | 说明 |
|------|------|------|------|
| 共识层 | NogoPow 算法实现 | consensus/nogopow/ | 抗 ASIC、CPU/GPU 友好的工作量证明算法 |
| 区块链 | 区块处理与链管理 | core/blockchain/ | 区块同步、验证、存储 |
| 状态管理 | 世界状态维护 | core/state/ | 账户状态、存储树 |
| 同步器 | 网络同步管理 | core/synchronizer/ | 区块同步、状态同步 |
| 验证器 | 交易和区块验证 | core/validator/ | 交易验证、区块验证 |
| 存储 | 数据持久化 | core/storage/ | 区块存储、状态存储、缓存管理 |
| 类型定义 | 核心数据结构 | core/types/ | 区块、交易、收据等类型定义 |
| EVM | 智能合约执行 | evm/core/vm/ | 兼容以太坊虚拟机 |
| 网络层 | P2P 通信 | network/ | 节点发现、数据同步、消息传递 |
| RPC 服务 | 外部接口 | rpc/ | 标准 EVM RPC + 自定义 Nogo 接口 |
| 挖矿 | 区块生产 | miner/ | 内置挖矿、Stratum 服务 |
| 命令行工具 | 客户端工具 | cmd/ | 节点、矿池、CLI 工具、挖矿工具 |

### 1.2 数据流

1. **交易处理**：接收交易 → 验证 → 内存池 → 打包
2. **区块生产**：NogoPow 计算 → 区块构建 → 广播
3. **区块同步**：接收区块 → 验证 → 执行 → 存储
4. **状态更新**：EVM 执行 → 状态变更 → 持久化
5. **网络通信**：节点发现 → 连接建立 → 数据传输 → 消息处理

## 2. 共识机制 (NogoPow)

### 2.1 设计目标

- **抗 ASIC**：通过随机内存访问和有限数据集大小（≤2GB）
- **CPU/GPU 友好**：无特殊指令，多线程优化
- **高性能**：桌面端 ≤5ms/计算，笔记本 ≤15ms
- **动态难度**：每 10 个区块调整一次（目标 20 秒/块），±50%
- **奖励机制**：初始 8 NOGO，每 500 万区块减产 20%，最低 0.1 NOGO

### 2.2 核心实现

- **算法**：基于内存密集型计算，结合随机访问模式
- **难度调整**：根据前 10 个区块的平均时间调整
- **验证**：轻量级验证，确保快速同步

## 3. EVM 实现

### 3.1 兼容性

- 完全兼容以太坊字节码
- 支持 ERC-20/721/1155 标准代币
- 兼容主流开发工具：Hardhat、Truffle、Foundry、Remix

### 3.2 优化

- 内存管理：高效内存分配与回收
- 执行速度：JIT 编译优化
- 存储访问：缓存机制减少磁盘 I/O

## 4. 网络层

### 4.1 P2P 通信

- 基于 Kademlia 发现算法
- 加密通信确保安全性
- 分块传输大文件

### 4.2 同步机制

- 快速同步：批量处理区块
- 状态同步：高效状态传输
- 分叉处理：自动选择最长链

## 5. RPC 服务

### 5.1 标准接口

- `eth_*`：以太坊标准接口，包括账户管理、区块查询、交易处理等
- `net_*`：网络状态查询，包括节点状态、网络版本等
- `web3_*`：Web3 标准接口，包括客户端版本、哈希计算等
- `debug_*`：调试接口，包括内存统计、区块追踪等

### 5.2 自定义接口

- `nogo_*`：NogoChain 特有功能
  - `nogo_getDifficulty`：获取当前难度
  - `nogo_getReward`：获取当前区块奖励
  - `nogo_getMiningInfo`：获取挖矿信息（难度、哈希率、奖励）
  - `nogo_getChainInfo`：获取链信息（链 ID、符号、共识算法等）
  - `nogo_getWork`：获取挖矿工作（NogoPow）
  - `nogo_submitWork`：提交挖矿工作（NogoPow）
  - `nogo_submitHashrate`：提交哈希率（NogoPow）

### 5.3 安全机制

- **JWT 认证**：公网 RPC 访问需 JWT 令牌认证
- **本地访问**：127.0.0.1 访问无需认证
- **速率限制**：防止 DDoS 攻击
- **权限控制**：可配置 RPC 接口访问权限

## 6. 存储架构

### 6.1 数据结构

- **区块存储**：LevelDB 键值存储
- **状态树**：Merkle Patricia Trie
- **交易索引**：快速查询索引

### 6.2 优化策略

- 批量写入减少磁盘操作
- 缓存热点数据
- 增量同步减少带宽

## 7. 安全机制

### 7.1 防护措施

- 防重放攻击：EIP-155 实现
- 防 DDoS：速率限制
- 智能合约安全：内置检查

### 7.2 审计要求

- 共识层、状态层、VM 层需第三方审计
- 定期安全更新

## 8. 部署架构

### 8.1 节点类型

- **全节点**：完整存储与验证
- **轻节点**：依赖全节点，快速同步
- **挖矿节点**：参与共识，生产区块

### 8.2 网络拓扑

- 骨干节点：高带宽、高可靠性
- 边缘节点：接入层，用户访问

## 9. 性能指标

### 9.1 目标性能

- TPS：≥ 1500
- 确认时间：~20 秒
- 同步速度：≥ 1000 区块/秒
- 存储增长：≤ 1GB/天

### 9.2 优化方向

- 并行处理：多线程验证
- 内存优化：减少 GC 压力
- 网络优化：压缩传输数据

## 10. 开发与测试

### 10.1 开发规范

- Go 标准风格
- 导出函数中文注释
- 包名小写，常量大写

### 10.2 测试要求

- 覆盖率 ≥80%
- 模糊测试：共识/加密模块
- 性能测试：计算时间 ≤5ms

## 11. 未来规划

### 11.1 短期目标

- 主网上线
- 生态工具完善
- 安全审计

### 11.2 长期规划

- 跨链互操作
- Layer 2 支持
- 隐私功能

## 12. 参考资料

- [以太坊黄皮书](https://ethereum.github.io/yellowpaper/paper.pdf)
- [Go 语言规范](https://golang.org/ref/spec)
- [区块链原理](https://github.com/ethereum/wiki/wiki/White-Paper)